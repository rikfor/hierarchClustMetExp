# README_HierClustExp
**Written by Rikard Forlin**
**25/1-2021**

## Intro
This project was a master thesis done as part of the medical program at Karolinska Institute, during the fall semester of 2020.
It aimed to identify previously unknown metabolites from peaks generated by LC-MS, by looking at m/z, retention time,
MIDs and their functional relationships found by hierarcical clustering.
The code is divided into 9 modules, each one explained below.
All datasets are handled by Roland Nilsson's group at Karolinska Institute.

## Module 1: Get all DataFrames
First module is comprised of several functions to generate all the datasets and estimating the biological CV. It ends with a box to run all functions, which will return:
- dfPANOLNo0/dfQCPeaksNo0: like dfPANOL, but where 0 values have been replaced by the minimum non-0 value of each row (peak)
- dfAnnot: DataFrame of all annotations found from HMDB
- z: Dictionary containing all annotations from HMDB
- dfCV: DataFrame containing peaks estimated biological CV, QC CV and observed CV (for those peaks where calculations were possible, eg. having QC value and QC CV < observed CV)
- dfPANOLMin: normalized dfPANOL, without 0-values (replaced by minimum row-value) and outliers (>4 set to = 4).
- dfPANOLWA: dfPANOL withouth annotations. Used for labeling leafs in the clustering


## Module 2: Sort and plot dfCV
A short module to examine the peaks CVs'. dfCV used, so only peaks with estimated biological CV can be viewed. Other peaks CV (with QC CV > observed CV) can also be viewed here, although one by one.

## Module 3: Clustering the peaks and samples
Clustering the peaks (rows) and samples (columns) of the normalized DF dfPANOLMin, using *correlation distance* as linkage metric, and *average* as linkage method.

Generates a clustermap, a dendrogram of the peaks, and a dendrogram of the clustered samples, where the leafs are colored according to their batch (too visualize batch effects).


## Module 4: Extracting clusters
Here we extract the generated clusters, by cutting of the dendrogram at height *0.6*, generating 91 clusters. We then sort them, and remove all the clusters not containing at least one previously unknown peak.
- Creates dfCA (dfClusterAssociations), containing clusters and their included metabolites (at least one unknown)


## Module 5: Analyzing extracted clusters
Defines two functions:
- *visClus*: Creates *spArray*, an array that contains pairwise spearman correlatinos between all peaks in the selected cluster.
- *runvisClus*: Runs visClus, returns spArray and all the names of the peaks in the cluster.

- Here we also look at chromatograms from peaks (examining if they are suspected fragments), look at scatterplot of correlating peaks and look at all the masses in the cluster.



## Module 6: Looking at MIDs from clusters
Extract all the MIDs from the peaks in the selected cluster and deleting all columns = 0 (no marking from isotope tracing). 
Generates *dfHeat* which is used to create a heatmap of the MIDs. We plot all of the peaks in one heatmap, and select a candidate to examine further and plot the candidate and the compounds with at least one similar MID (eg both being marked from glucose C2).

Can also look at a specifik MID in list-format (prints out from dfHeat).


## Module 7: Checking Disease Associations
Using previously generated dataset, we check the peaks disease associations by excluding all the p-values > 0.05 (*dfDisFilt*).

## Module 8: M/Z - RT plots
Short module for generating figures to the report
- Plotting the plate means together with sample number and drawing red lines between batches (checking for batch effects). Red lines are drawn at positions defined by "bracketLines" in function *plateRunMet*, change if necessary.
- Scatterplot of observed CV vs estimated biological CV

- Also includes a linear plot of samples runtime. 

## Module 9: creating dfPANOL, random scatterplots
- Used to create dfPANOL from dfPeakAreas by excluding all the overlapping peaks. dfPANOL is already generated, kept for methodology.

- Creating random scatterplots to get a feeling of what intensities different peaks could have (used to get a first overlook of the dataset at the beginning of the project)

- A figure plot a observed intensity and QC intensity, to see how they relate to each other.



